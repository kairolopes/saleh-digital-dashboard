<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Saleh Digital - Painel de Gest√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Scroll bonito na tabela */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 9999px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: transparent;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-950 border-r border-slate-800 hidden md:flex flex-col">
      <div class="px-6 py-5 border-b border-slate-800 flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-amber-400 to-rose-500 flex items-center justify-center text-slate-950 font-black">
          S
        </div>
        <div>
          <div class="font-semibold text-slate-50">Saleh Digital</div>
          <div class="text-xs text-slate-400">Painel de gest√£o do restaurante</div>
        </div>
      </div>

      <nav class="flex-1 px-4 py-4 space-y-1">
        <button id="menu-estoque" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-medium bg-slate-800 text-amber-400">
          <span>üì¶</span> <span>Estoque</span>
        </button>
        <button id="menu-pedidos" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>üßæ</span> <span>Pedidos (visualiza√ß√£o)</span>
        </button>
        <button id="menu-sobre" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>‚öôÔ∏è</span> <span>Sobre / Ajuda</span>
        </button>
      </nav>

      <div class="px-6 py-4 border-t border-slate-800 text-xs text-slate-500">
        API conectada ao Firebase<br/>
        <span id="api-status-text">Verificando status...</span>
      </div>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="flex-1 flex flex-col">
      <!-- Topbar -->
      <header class="h-16 border-b border-slate-800 flex items-center justify-between px-4 md:px-8 bg-slate-950/90 backdrop-blur">
        <div class="flex items-center gap-3">
          <div class="md:hidden">
            <!-- (poderia ter menu m√≥vel depois) -->
          </div>
          <div>
            <div class="text-sm text-slate-400">Dashboard</div>
            <h1 class="text-lg md:text-xl font-semibold text-slate-50">Painel de Gest√£o Saleh Digital</h1>
          </div>
        </div>
        <div class="flex items-center gap-3 text-xs md:text-sm text-slate-400">
          <span class="hidden sm:inline">Ambiente:</span>
          <span class="px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 text-[11px] md:text-xs">
            API Online
          </span>
        </div>
      </header>

      <!-- Conte√∫do -->
      <section class="flex-1 p-4 md:p-8 space-y-6">

        <!-- CARDS RESUMO -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Produtos cadastrados</span>
              <span class="text-lg">üì¶</span>
            </div>
            <div class="text-2xl font-semibold text-slate-50" id="card-total-products">0</div>
            <div class="text-xs text-slate-500">Itens de insumo controlados no estoque</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Pedidos pendentes</span>
              <span class="text-lg">üßæ</span>
            </div>
            <div class="text-2xl font-semibold text-slate-50" id="card-pending-orders">0</div>
            <div class="text-xs text-slate-500">Pedidos que ainda n√£o foram finalizados</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Status da API</span>
              <span class="text-lg">üåê</span>
            </div>
            <div class="text-sm font-medium text-emerald-400" id="card-api-status">Verificando...</div>
            <div class="text-xs text-slate-500" id="card-api-url"></div>
          </div>
        </div>

        <!-- CONTE√öDO DAS ABAS -->
        <!-- ABA ESTOQUE -->
        <div id="tab-estoque" class="space-y-6">
          <div class="flex flex-col md:flex-row md:items-center gap-3 justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Estoque de Insumos</h2>
              <p class="text-sm text-slate-400">Cadastre produtos, veja o saldo atual e registre compras.</p>
            </div>
            <button id="btn-open-product-form" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium bg-amber-500 text-slate-950 hover:bg-amber-400 transition">
              <span>‚ûï</span> <span>Novo produto</span>
            </button>
          </div>

          <!-- Formul√°rio de produto (toggle) -->
          <div id="product-form-container" class="rounded-2xl bg-slate-950 border border-slate-800 p-4 md:p-5 hidden">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">Cadastrar novo insumo</h3>
                <p class="text-xs text-slate-500">Preencha os dados e salve para criar o produto no estoque.</p>
              </div>
              <button id="btn-close-product-form" class="text-xs text-slate-400 hover:text-slate-200">
                ‚úï Fechar
              </button>
            </div>

            <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div class="md:col-span-2">
                <label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label>
                <input type="text" id="pf-description" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-amber-500" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Unidade (kg, g, L, un)</label>
                <input type="text" id="pf-unit" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Tamanho da unidade (ex: 5kg, 500g)</label>
                <input type="text" id="pf-unitSize"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Valor da unidade (R$)</label>
                <input type="number" step="0.01" id="pf-unitPrice" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Rendimento (%)</label>
                <input type="number" id="pf-yieldPercent" value="100"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div class="md:col-span-2">
                <label class="block text-xs text-slate-400 mb-1">Observa√ß√µes</label>
                <input type="text" id="pf-notes"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Local de compra</label>
                <input type="text" id="pf-location"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Quantidade atual no estoque</label>
                <input type="number" step="0.01" id="pf-currentQuantity" value="0"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div class="md:col-span-3 flex justify-end gap-3 mt-2">
                <button type="button" id="btn-cancel-product" class="px-3 py-2 rounded-xl text-xs border border-slate-700 text-slate-300 hover:bg-slate-800">
                  Cancelar
                </button>
                <button type="submit" class="px-4 py-2 rounded-xl text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400">
                  Salvar produto
                </button>
              </div>
            </form>
          </div>

          <!-- Barra de busca + filtros -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <div class="relative">
                <input id="search-products" type="text" placeholder="Buscar por descri√ß√£o, unidade ou local..."
                  class="w-64 max-w-full pl-8 pr-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-amber-500" />
                <span class="absolute left-2 top-1.5 text-slate-500 text-sm">üîç</span>
              </div>
            </div>
            <div class="text-xs text-slate-500">
              Clique em <span class="font-semibold text-amber-400">‚ÄúRegistrar compra‚Äù</span> para atualizar estoque e hist√≥rico.
            </div>
          </div>

          <!-- TABELA DE PRODUTOS -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 overflow-hidden">
            <div class="max-h-[320px] overflow-auto scrollbar-thin">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/60 sticky top-0 z-10">
                  <tr>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Descri√ß√£o</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Unidade</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Valor un. (R$)</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Qtd. atual</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Local</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="products-table-body" class="divide-y divide-slate-800">
                  <!-- Linhas via JS -->
                </tbody>
              </table>
            </div>
            <div class="px-4 py-2 text-[11px] text-slate-500 border-t border-slate-800">
              Mostrando <span id="products-count">0</span> produtos.
            </div>
          </div>

          <!-- GR√ÅFICO -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 p-4 md:p-5">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">Top produtos por quantidade em estoque</h3>
                <p class="text-xs text-slate-500">Visualize rapidamente os itens com maior saldo.</p>
              </div>
            </div>
            <canvas id="stockChart" class="w-full h-64"></canvas>
          </div>
        </div>

        <!-- ABA PEDIDOS (apenas visualiza√ß√£o simples por enquanto) -->
        <div id="tab-pedidos" class="space-y-4 hidden">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Pedidos (vis√£o r√°pida)</h2>
              <p class="text-sm text-slate-400">Lista pedidos por status para a cozinha e atendimento.</p>
            </div>
            <select id="orders-status-filter"
              class="rounded-xl bg-slate-950 border border-slate-800 text-xs px-3 py-2">
              <option value="pendente">Pendentes</option>
              <option value="aceito_cozinha">Aceitos pela cozinha</option>
              <option value="pronto">Prontos</option>
              <option value="entregue">Entregues</option>
              <option value="cancelado">Cancelados</option>
            </select>
          </div>

          <div class="rounded-2xl bg-slate-950 border border-slate-800 overflow-hidden">
            <div class="max-h-[360px] overflow-auto scrollbar-thin">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/60 sticky top-0 z-10">
                  <tr>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Mesa / Canal</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Cliente</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Itens</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Status</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="orders-table-body" class="divide-y divide-slate-800">
                  <!-- via JS -->
                </tbody>
              </table>
            </div>
            <div class="px-4 py-2 text-[11px] text-slate-500 border-t border-slate-800">
              Encontrados <span id="orders-count">0</span> pedidos neste status.
            </div>
          </div>

          <p class="text-xs text-slate-500">
            Os pedidos podem ser criados pelo gar√ßom, app do cliente ou Nicochat, todos usando a mesma API.
          </p>
        </div>

        <!-- ABA SOBRE -->
        <div id="tab-sobre" class="space-y-3 hidden text-sm text-slate-300">
          <h2 class="text-lg font-semibold text-slate-50">Sobre o painel</h2>
          <p>
            Este painel consome a API
            <code class="px-2 py-1 rounded bg-slate-900 border border-slate-800 text-xs" id="about-api-url"></code>
            conectada ao Firebase (Firestore).
          </p>
          <ul class="list-disc ml-5 space-y-1 text-slate-400 text-xs">
            <li>Cadastro e listagem de insumos em <code>/products</code>.</li>
            <li>Hist√≥rico de compras e estoque em <code>/products/:id/purchase</code> e <code>/products/:id/history</code>.</li>
            <li>Pedidos de mesa, app e Nicochat em <code>/orders</code>.</li>
            <li>Clientes (CRM simples) em <code>/customers</code> e <code>/customers/:phone</code>.</li>
          </ul>
          <p class="text-xs text-slate-500">
            Pr√≥ximos passos: tela de hist√≥rico detalhado, custos por prato, relat√≥rios por per√≠odo e integra√ß√£o visual com Nicochat.
          </p>
        </div>

      </section>
    </main>
  </div>

  <script>
    // üîó URL da sua API no Render
    const API_BASE = "https://saleh-digital-api.onrender.com";

    // Refer√™ncias de elementos
    const apiStatusText = document.getElementById("api-status-text");
    const cardApiStatus = document.getElementById("card-api-status");
    const cardApiUrl = document.getElementById("card-api-url");
    const cardTotalProducts = document.getElementById("card-total-products");
    const cardPendingOrders = document.getElementById("card-pending-orders");
    const aboutApiUrl = document.getElementById("about-api-url");

    const tabEstoque = document.getElementById("tab-estoque");
    const tabPedidos = document.getElementById("tab-pedidos");
    const tabSobre = document.getElementById("tab-sobre");

    const btnMenuEstoque = document.getElementById("menu-estoque");
    const btnMenuPedidos = document.getElementById("menu-pedidos");
    const btnMenuSobre = document.getElementById("menu-sobre");

    const btnOpenProductForm = document.getElementById("btn-open-product-form");
    const btnCloseProductForm = document.getElementById("btn-close-product-form");
    const btnCancelProduct = document.getElementById("btn-cancel-product");
    const productFormContainer = document.getElementById("product-form-container");
    const productForm = document.getElementById("product-form");

    const productsTableBody = document.getElementById("products-table-body");
    const productsCount = document.getElementById("products-count");
    const searchProductsInput = document.getElementById("search-products");

    const ordersStatusFilter = document.getElementById("orders-status-filter");
    const ordersTableBody = document.getElementById("orders-table-body");
    const ordersCount = document.getElementById("orders-count");

    let allProducts = [];
    let stockChart = null;

    // -----------------------------
    // Alternar abas
    // -----------------------------
    function showTab(tab) {
      tabEstoque.classList.add("hidden");
      tabPedidos.classList.add("hidden");
      tabSobre.classList.add("hidden");

      btnMenuEstoque.classList.remove("bg-slate-800", "text-amber-400");
      btnMenuEstoque.classList.add("text-slate-300");
      btnMenuPedidos.classList.remove("bg-slate-800", "text-amber-400");
      btnMenuPedidos.classList.add("text-slate-300");
      btnMenuSobre.classList.remove("bg-slate-800", "text-amber-400");
      btnMenuSobre.classList.add("text-slate-300");

      if (tab === "estoque") {
        tabEstoque.classList.remove("hidden");
        btnMenuEstoque.classList.add("bg-slate-800", "text-amber-400");
        btnMenuEstoque.classList.remove("text-slate-300");
      } else if (tab === "pedidos") {
        tabPedidos.classList.remove("hidden");
        btnMenuPedidos.classList.add("bg-slate-800", "text-amber-400");
        btnMenuPedidos.classList.remove("text-slate-300");
      } else if (tab === "sobre") {
        tabSobre.classList.remove("hidden");
        btnMenuSobre.classList.add("bg-slate-800", "text-amber-400");
        btnMenuSobre.classList.remove("text-slate-300");
      }
    }

    btnMenuEstoque.addEventListener("click", () => showTab("estoque"));
    btnMenuPedidos.addEventListener("click", () => {
      showTab("pedidos");
      loadOrders();
    });
    btnMenuSobre.addEventListener("click", () => showTab("sobre"));

    // -----------------------------
    // Abrir / fechar formul√°rio
    // -----------------------------
    function openProductForm() {
      productFormContainer.classList.remove("hidden");
    }
    function closeProductForm() {
      productFormContainer.classList.add("hidden");
    }

    btnOpenProductForm.addEventListener("click", openProductForm);
    btnCloseProductForm.addEventListener("click", closeProductForm);
    btnCancelProduct.addEventListener("click", closeProductForm);

    // -----------------------------
    // Buscar status da API
    // -----------------------------
    async function checkApiStatus() {
      try {
        const res = await fetch(API_BASE + "/");
        if (!res.ok) throw new Error("Status n√£o OK");
        const text = await res.text();
        apiStatusText.textContent = "Online";
        cardApiStatus.textContent = "API em funcionamento";
        cardApiStatus.classList.remove("text-slate-400");
        cardApiStatus.classList.add("text-emerald-400");
      } catch (err) {
        apiStatusText.textContent = "Offline ou indispon√≠vel";
        cardApiStatus.textContent = "Erro ao conectar na API";
        cardApiStatus.classList.remove("text-emerald-400");
        cardApiStatus.classList.add("text-rose-400");
      }
      cardApiUrl.textContent = API_BASE;
      aboutApiUrl.textContent = API_BASE;
    }

    // -----------------------------
    // Carregar produtos
    // -----------------------------
    async function loadProducts() {
      try {
        const res = await fetch(API_BASE + "/products");
        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];
        renderProductsTable();
        cardTotalProducts.textContent = allProducts.length.toString();
        updateStockChart();
      } catch (err) {
        console.error("Erro ao carregar produtos:", err);
      }
    }

    function renderProductsTable() {
      const term = searchProductsInput.value.toLowerCase();
      const filtered = allProducts.filter(p => {
        const desc = (p.description || "").toLowerCase();
        const unit = (p.unit || "").toLowerCase();
        const loc = (p.location || "").toLowerCase();
        return (
          desc.includes(term) ||
          unit.includes(term) ||
          loc.includes(term)
        );
      });

      productsTableBody.innerHTML = "";

      if (filtered.length === 0) {
        productsTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-4 text-xs text-slate-500 text-center">
              Nenhum produto encontrado.
            </td>
          </tr>
        `;
        productsCount.textContent = "0";
        return;
      }

      filtered.forEach(p => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60";

        const currentQty = Number(p.currentQuantity || 0);
        const unitPrice = Number(p.unitPrice || 0);

tr.innerHTML = `
  <td class="px-4 py-3 text-sm">${p.description || "-"}</td>
  <td class="px-4 py-3 text-sm">${p.unit || "-"}</td>
  <td class="px-4 py-3 text-sm text-right">R$ ${unitPrice.toFixed(2)}</td>
  <td class="px-4 py-3 text-sm text-right">${currentQty.toFixed(2)}</td>
  <td class="px-4 py-3 text-xs text-slate-400">${p.location || "-"}</td>

  <td class="px-4 py-3 text-right text-xs whitespace-nowrap text-amber-400 font-medium">
    <span class="cursor-pointer hover:underline" data-action="purchase" data-id="${p.id}">
      Registrar
    </span>
    ‚Ä¢
    <span class="cursor-pointer hover:underline text-slate-300" data-action="edit" data-id="${p.id}">
      Editar
    </span>
    ‚Ä¢
    <span class="cursor-pointer hover:underline text-slate-400" data-action="history" data-id="${p.id}">
      Hist√≥rico
    </span>
  </td>
`;



        productsTableBody.appendChild(tr);
      });

      productsCount.textContent = filtered.length.toString();
    }

    // Buscar enquanto digita
    searchProductsInput.addEventListener("input", () => {
      renderProductsTable();
    });

    // -----------------------------
    // Registrar nova compra (estoque)
    // -----------------------------
    async function handlePurchase(productId) {
      const quantityStr = prompt("Quantidade comprada (mesma unidade do produto):");
      if (!quantityStr) return;
      const quantity = Number(quantityStr.replace(",", "."));
      if (isNaN(quantity) || quantity <= 0) {
        alert("Quantidade inv√°lida.");
        return;
      }

      const totalStr = prompt("Valor total pago (R$):");
      if (!totalStr) return;
      const totalPrice = Number(totalStr.replace(",", "."));
      if (isNaN(totalPrice) || totalPrice <= 0) {
        alert("Valor inv√°lido.");
        return;
      }

      const dateStr = prompt("Data da compra (AAAA-MM-DD). Deixe em branco para usar a data de hoje:");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const purchaseDate = dateStr && dateStr.trim() !== "" ? dateStr.trim() : `${yyyy}-${mm}-${dd}`;

      try {
        const res = await fetch(`${API_BASE}/products/${productId}/purchase`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity, totalPrice, purchaseDate })
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao registrar compra:", errText);
          alert("Erro ao registrar compra. Veja o console para detalhes.");
          return;
        }

        alert("Compra registrada com sucesso! Estoque atualizado.");
        await loadProducts();
      } catch (err) {
        console.error("Erro na requisi√ß√£o de compra:", err);
        alert("Erro de conex√£o ao registrar compra.");
      }
    }


productsTableBody.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;

  const action = btn.getAttribute("data-action");
  const id = btn.getAttribute("data-id");
  if (!id) return;

  if (action === "purchase") {
    handlePurchase(id);
  } else if (action === "edit") {
    handleEditProduct(id);
  } else if (action === "history") {
    handleShowHistory(id);
  }
});

// ‚úèÔ∏è Editar dados b√°sicos do produto (por enquanto, s√≥ descri√ß√£o)
async function handleEditProduct(productId) {
  // pega o produto da lista em mem√≥ria
  const product = allProducts.find(p => p.id === productId);
  if (!product) {
    alert("Produto n√£o encontrado na lista carregada.");
    return;
  }

  const novaDescricao = prompt(
    "Nova descri√ß√£o para o produto:",
    product.description || ""
  );

  if (!novaDescricao || novaDescricao.trim() === "") {
    // usu√°rio cancelou ou deixou vazio
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/products/${productId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ description: novaDescricao.trim() })
    });

    if (!res.ok) {
      const errText = await res.text();
      console.error("Erro ao editar produto:", errText);
      alert("Erro ao editar produto. Veja o console para detalhes.");
      return;
    }

    alert("Produto atualizado com sucesso!");
    await loadProducts(); // recarrega a lista
  } catch (err) {
    console.error("Erro na requisi√ß√£o de edi√ß√£o:", err);
    alert("Erro de conex√£o ao editar produto.");
  }
}

// üìú Mostrar hist√≥rico de compras do produto
async function handleShowHistory(productId) {
  try {
    const res = await fetch(`${API_BASE}/products/${productId}/history`);
    if (!res.ok) {
      const errText = await res.text();
      console.error("Erro ao buscar hist√≥rico:", errText);
      alert("Erro ao buscar hist√≥rico de compras.");
      return;
    }

    const history = await res.json();

    if (!Array.isArray(history) || history.length === 0) {
      alert("Nenhuma compra registrada para este produto.");
      return;
    }

    // monta um texto simples com data, quantidade e valor
    let texto = "Hist√≥rico de compras:\n\n";
    history.forEach((h) => {
      const qtd = Number(h.quantity || 0);
      const total = Number(h.totalPrice || 0);
      const unit = qtd > 0 ? total / qtd : 0;
      const data = h.purchaseDate || h.date || "";

      texto += `Data: ${data}\n`;
      texto += `Quantidade: ${qtd}\n`;
      texto += `Valor total: R$ ${total.toFixed(2)}\n`;
      texto += `Valor unit√°rio: R$ ${unit.toFixed(2)}\n`;
      texto += "-----------------------------\n";
    });

    alert(texto);
  } catch (err) {
    console.error("Erro na requisi√ß√£o de hist√≥rico:", err);
    alert("Erro de conex√£o ao buscar hist√≥rico.");
  }
}


    
    // -----------------------------
    // Submeter formul√°rio de novo produto
    // -----------------------------
    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const description = document.getElementById("pf-description").value.trim();
      const unit = document.getElementById("pf-unit").value.trim();
      const unitSize = document.getElementById("pf-unitSize").value.trim();
      const unitPrice = Number(document.getElementById("pf-unitPrice").value.replace(",", "."));
      const yieldPercent = Number(document.getElementById("pf-yieldPercent").value || 100);
      const notes = document.getElementById("pf-notes").value.trim();
      const location = document.getElementById("pf-location").value.trim();
      const currentQuantity = Number(document.getElementById("pf-currentQuantity").value.replace(",", ".") || 0);

      if (!description || !unit || isNaN(unitPrice)) {
        alert("Preencha ao menos descri√ß√£o, unidade e valor da unidade.");
        return;
      }

      const body = {
        description,
        unit,
        unitSize,
        unitPrice,
        yieldPercent,
        notes,
        location,
        previousQuantity: 0,
        purchaseQuantity: 0,
        currentQuantity
      };

      try {
        const res = await fetch(API_BASE + "/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao criar produto:", errText);
          alert("Erro ao criar produto. Veja o console para detalhes.");
          return;
        }

        alert("Produto cadastrado com sucesso!");
        productForm.reset();
        document.getElementById("pf-yieldPercent").value = 100;
        document.getElementById("pf-currentQuantity").value = 0;
        closeProductForm();
        await loadProducts();
      } catch (err) {
        console.error("Erro na requisi√ß√£o de produto:", err);
        alert("Erro de conex√£o ao salvar produto.");
      }
    });

    // -----------------------------
    // Carregar pedidos (para aba pedidos)
    // -----------------------------
    async function loadOrders() {
      const status = ordersStatusFilter.value;
      try {
        const res = await fetch(`${API_BASE}/orders?status=${encodeURIComponent(status)}`);
        const data = await res.json();
        const orders = Array.isArray(data) ? data : [];
        renderOrdersTable(orders);
        cardPendingOrders.textContent = status === "pendente" ? orders.length.toString() : cardPendingOrders.textContent;
      } catch (err) {
        console.error("Erro ao carregar pedidos:", err);
      }
    }

    function renderOrdersTable(orders) {
      ordersTableBody.innerHTML = "";
      if (orders.length === 0) {
        ordersTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-4 text-xs text-slate-500 text-center">
              Nenhum pedido encontrado para este status.
            </td>
          </tr>
        `;
        ordersCount.textContent = "0";
        return;
      }

      orders.forEach(o => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60 text-xs";
        const itemsText = Array.isArray(o.items)
          ? o.items.map(i => `${i.qty}x ${i.name}`).join(", ")
          : "-";

        tr.innerHTML = `
          <td class="px-4 py-2 align-top">
            <div class="font-medium text-slate-100">${o.tableNumber || "-"}</div>
            <div class="text-[11px] text-slate-500">${o.channel || "-"}</div>
          </td>
          <td class="px-4 py-2 align-top">${o.customerName || "-"}</td>
          <td class="px-4 py-2 align-top">${itemsText}</td>
          <td class="px-4 py-2 align-top">
            <span class="px-2 py-1 rounded-full text-[10px] bg-slate-900 border border-slate-700 text-slate-200">
              ${o.status}
            </span>
          </td>
          <td class="px-4 py-2 align-top text-right">
            <!-- Aqui depois d√° pra colocar bot√µes de mudar status -->
          </td>
        `;
        ordersTableBody.appendChild(tr);
      });

      ordersCount.textContent = orders.length.toString();
    }

    ordersStatusFilter.addEventListener("change", () => {
      loadOrders();
    });

    // -----------------------------
    // Gr√°fico de estoque
    // -----------------------------
    function updateStockChart() {
      const ctx = document.getElementById("stockChart");
      if (!ctx) return;

      const sorted = [...allProducts].sort((a, b) => (Number(b.currentQuantity || 0) - Number(a.currentQuantity || 0)));
      const top = sorted.slice(0, 6);
      const labels = top.map(p => p.description || "");
      const values = top.map(p => Number(p.currentQuantity || 0));

      if (stockChart) {
        stockChart.destroy();
      }

      stockChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Quantidade atual",
            data: values
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: "#e5e7eb", font: { size: 11 } }
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" }
            },
            y: {
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" }
            }
          }
        }
      });
    }

    // -----------------------------
    // Inicializa√ß√£o
    // -----------------------------
    async function initDashboard() {
      await checkApiStatus();
      await loadProducts();
      await loadOrders();
      showTab("estoque");
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>
