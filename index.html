<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Saleh Digital - Painel de Gest√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 9999px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: transparent;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-950 border-r border-slate-800 hidden md:flex flex-col">
      <div class="px-6 py-5 border-b border-slate-800 flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-amber-400 to-rose-500 flex items-center justify-center text-slate-950 font-black">
          S
        </div>
        <div>
          <div class="font-semibold text-slate-50">Saleh Digital</div>
          <div class="text-xs text-slate-400">Painel de gest√£o do restaurante</div>
        </div>
      </div>

      <nav class="flex-1 px-4 py-4 space-y-1">
        <button id="menu-estoque" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-medium bg-slate-800 text-amber-400">
          <span>üì¶</span> <span>Estoque</span>
        </button>

        <button id="menu-pedidos" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>üßæ</span> <span>Pedidos (visualiza√ß√£o)</span>
        </button>

        <button id="menu-crm" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>üë§</span> <span>CRM / Clientes</span>
        </button>

        <!-- NOVO: menu de Fichas t√©cnicas -->
        <button id="menu-fichas" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>üçù</span> <span>Fichas t√©cnicas</span>
        </button>

        <button id="menu-sobre" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-slate-300 hover:bg-slate-800/60">
          <span>‚öôÔ∏è</span> <span>Sobre / Ajuda</span>
        </button>
      </nav>


      <div class="px-6 py-4 border-t border-slate-800 text-xs text-slate-500">
        API conectada ao Firebase<br/>
        <span id="api-status-text">Verificando status...</span>
      </div>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="flex-1 flex flex-col">
      <!-- Topbar -->
      <header class="h-16 border-b border-slate-800 flex items-center justify-between px-4 md:px-8 bg-slate-950/90 backdrop-blur">
        <div class="flex items-center gap-3">
          <div class="md:hidden"></div>
          <div>
            <div class="text-sm text-slate-400">Dashboard</div>
            <h1 class="text-lg md:text-xl font-semibold text-slate-50">Painel de Gest√£o Saleh Digital</h1>
          </div>
        </div>
        <div class="flex items-center gap-3 text-xs md:text-sm text-slate-400">
          <span class="hidden sm:inline">Ambiente:</span>
          <span class="px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 text-[11px] md:text-xs">
            API Online
          </span>
        </div>
      </header>

      <!-- Conte√∫do -->
      <section class="flex-1 p-4 md:p-8 space-y-6">

        <!-- CARDS RESUMO -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Produtos cadastrados</span>
              <span class="text-lg">üì¶</span>
            </div>
            <div class="text-2xl font-semibold text-slate-50" id="card-total-products">0</div>
            <div class="text-xs text-slate-500">Itens de insumo controlados no estoque</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Pedidos pendentes</span>
              <span class="text-lg">üßæ</span>
            </div>
            <div class="text-2xl font-semibold text-slate-50" id="card-pending-orders">0</div>
            <div class="text-xs text-slate-500">Pedidos que ainda n√£o foram finalizados</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs uppercase tracking-wide text-slate-400">Status da API</span>
              <span class="text-lg">üåê</span>
            </div>
            <div class="text-sm font-medium text-emerald-400" id="card-api-status">Verificando...</div>
            <div class="text-xs text-slate-500" id="card-api-url"></div>
          </div>
        </div>

        <!-- ABA ESTOQUE -->
        <div id="tab-estoque" class="space-y-6">
          <div class="flex flex-col md:flex-row md:items-center gap-3 justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Estoque de Insumos</h2>
              <p class="text-sm text-slate-400">Cadastre produtos, veja o saldo atual e registre compras.</p>
            </div>
            <button id="btn-open-product-form" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium bg-amber-500 text-slate-950 hover:bg-amber-400 transition">
              <span>‚ûï</span> <span>Novo produto</span>
            </button>
          </div>

          <!-- Formul√°rio de produto -->
          <div id="product-form-container" class="rounded-2xl bg-slate-950 border border-slate-800 p-4 md:p-5 hidden">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">Cadastrar novo insumo</h3>
                <p class="text-xs text-slate-500">Preencha os dados e salve para criar o produto no estoque.</p>
              </div>
              <button id="btn-close-product-form" class="text-xs text-slate-400 hover:text-slate-200">
                ‚úï Fechar
              </button>
            </div>

            <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div class="md:col-span-2">
                <label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label>
                <input type="text" id="pf-description" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-amber-500" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Unidade (kg, g, L, un)</label>
                <input type="text" id="pf-unit" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Tamanho da unidade (ex: 5kg, 500g)</label>
                <input type="text" id="pf-unitSize"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Valor da unidade (R$)</label>
                <input type="number" step="0.01" id="pf-unitPrice" required
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Rendimento (%)</label>
                <input type="number" id="pf-yieldPercent" value="100"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div class="md:col-span-2">
                <label class="block text-xs text-slate-400 mb-1">Observa√ß√µes</label>
                <input type="text" id="pf-notes"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Local de compra</label>
                <input type="text" id="pf-location"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Quantidade atual no estoque</label>
                <input type="number" step="0.01" id="pf-currentQuantity" value="0"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div class="md:col-span-3 flex justify-end gap-3 mt-2">
                <button type="button" id="btn-cancel-product" class="px-3 py-2 rounded-xl text-xs border border-slate-700 text-slate-300 hover:bg-slate-800">
                  Cancelar
                </button>
                <button type="submit" class="px-4 py-2 rounded-xl text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400">
                  Salvar produto
                </button>
              </div>
            </form>
          </div>

          <!-- Barra de busca -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <div class="relative">
                <input id="search-products" type="text" placeholder="Buscar por descri√ß√£o, unidade ou local..."
                  class="w-64 max-w-full pl-8 pr-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-amber-500" />
                <span class="absolute left-2 top-1.5 text-slate-500 text-sm">üîç</span>
              </div>
            </div>
            <div class="text-xs text-slate-500">
              Clique em <span class="font-semibold text-amber-400">‚ÄúRegistrar‚Äù</span> para atualizar estoque e hist√≥rico.
            </div>
          </div>

          <!-- TABELA DE PRODUTOS -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 overflow-hidden">
            <div class="max-h-[320px] overflow-auto scrollbar-thin">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/60 sticky top-0 z-10">
                  <tr>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Descri√ß√£o</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Unidade</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">Valor un. (R$)</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">Qtd. atual</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Local</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="products-table-body" class="divide-y divide-slate-800">
                  <!-- Linhas via JS -->
                </tbody>
              </table>
            </div>
            <div class="px-4 py-2 text-[11px] text-slate-500 border-t border-slate-800">
              Mostrando <span id="products-count">0</span> produtos.
            </div>
          </div>

          <!-- GR√ÅFICO -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 p-4 md:p-5">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">Top produtos por quantidade em estoque</h3>
                <p class="text-xs text-slate-500">Visualize rapidamente os itens com maior saldo.</p>
              </div>
            </div>
            <canvas id="stockChart" class="w-full h-64"></canvas>
          </div>
        </div>


                <!-- ABA FICHAS T√âCNICAS -->
        <div id="tab-fichas" class="space-y-4 hidden">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Fichas t√©cnicas de pratos</h2>
              <p class="text-sm text-slate-400">
                Monte o prato usando os insumos do estoque para ver custo e CMV.
              </p>
            </div>
            <button
              id="btn-open-dish-modal"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium bg-amber-500 text-slate-950 hover:bg-amber-400 transition"
            >
              <span>‚ûï</span>
              <span>Nova ficha t√©cnica</span>
            </button>
          </div>

          <!-- ONDE OS CARDS DE PRATOS V√ÉO APARECER -->
          <div
            id="dish-cards"
            class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"
          >
            <div
              class="col-span-1 md:col-span-2 xl:col-span-3 text-xs text-slate-500 border border-dashed border-slate-800 rounded-2xl px-4 py-6 text-center"
            >
              Nenhuma ficha cadastrada ainda.
              Clique em <span class="font-semibold text-amber-400">‚ÄúNova ficha t√©cnica‚Äù</span> para criar a primeira.
            </div>
          </div>
        </div>

        
        <!-- ABA PEDIDOS -->
        <div id="tab-pedidos" class="space-y-4 hidden">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Pedidos (vis√£o r√°pida)</h2>
              <p class="text-sm text-slate-400">Lista pedidos por status para a cozinha e atendimento.</p>
            </div>
            <select id="orders-status-filter"
              class="rounded-xl bg-slate-950 border border-slate-800 text-xs px-3 py-2">
              <option value="pendente">Pendentes</option>
              <option value="aceito_cozinha">Aceitos pela cozinha</option>
              <option value="pronto">Prontos</option>
              <option value="entregue">Entregues</option>
              <option value="cancelado">Cancelados</option>
            </select>
          </div>

          <div class="rounded-2xl bg-slate-950 border border-slate-800 overflow-hidden">
            <div class="max-h-[360px] overflow-auto scrollbar-thin">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/60 sticky top-0 z-10">
                  <tr>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Mesa / Canal</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Cliente</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Itens</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Status</th>
                    <th class="text-right px-4 py-2 text-xs font-semibold text-slate-400">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="orders-table-body" class="divide-y divide-slate-800">
                  <!-- via JS -->
                </tbody>
              </table>
            </div>
            <div class="px-4 py-2 text-[11px] text-slate-500 border-t border-slate-800">
              Encontrados <span id="orders-count">0</span> pedidos neste status.
            </div>
          </div>

          <p class="text-xs text-slate-500">
            Os pedidos podem ser criados pelo gar√ßom, app do cliente ou Nicochat, todos usando a mesma API.
          </p>
        </div>

        <!-- ABA CRM -->
        <div id="tab-crm" class="space-y-4 hidden">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold text-slate-50">Clientes / CRM</h2>
              <p class="text-sm text-slate-400">Cadastre clientes e veja quem j√° est√° na base.</p>
            </div>
          </div>

          <!-- Formul√°rio de cliente -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 p-4 md:p-5">
            <form id="crm-form" class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
              <div class="md:col-span-2">
                <label class="block text-xs text-slate-400 mb-1">Nome</label>
                <input type="text" id="crm-name"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Telefone (DDD+N√∫mero)</label>
                <input type="text" id="crm-phone" placeholder="62999999999"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div>
                <label class="block text-xs text-slate-400 mb-1">Canal</label>
                <select id="crm-channel"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2">
                  <option value="presencial">Presencial</option>
                  <option value="garcom">Gar√ßom</option>
                  <option value="nicochat">Nicochat</option>
                  <option value="app">App / Online</option>
                </select>
              </div>

              <div class="md:col-span-4">
                <label class="block text-xs text-slate-400 mb-1">Observa√ß√µes</label>
                <input type="text" id="crm-notes"
                  class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2" />
              </div>

              <div class="md:col-span-4 flex justify-end gap-3">
                <button type="submit"
                  class="px-4 py-2 rounded-xl text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400">
                  Salvar cliente
                </button>
              </div>
            </form>
          </div>

          <!-- Filtros / busca -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div class="relative">
              <input id="search-customers" type="text" placeholder="Buscar por nome, telefone ou canal..."
                class="w-64 max-w-full pl-8 pr-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-amber-500" />
              <span class="absolute left-2 top-1.5 text-slate-500 text-sm">üîç</span>
            </div>
            <div class="text-xs text-slate-500">
              Clientes cadastrados via gar√ßom, app, Nicochat ou atendimento presencial.
            </div>
          </div>

          <!-- Tabela de clientes -->
          <div class="rounded-2xl bg-slate-950 border border-slate-800 overflow-hidden">
            <div class="max-h-[320px] overflow-auto scrollbar-thin">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/60 sticky top-0 z-10">
                  <tr>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Nome</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Telefone</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Canal</th>
                    <th class="text-left px-4 py-2 text-xs font-semibold text-slate-400">Observa√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="customers-table-body" class="divide-y divide-slate-800">
                  <!-- via JS -->
                </tbody>
              </table>
            </div>
            <div class="px-4 py-2 text-[11px] text-slate-500 border-t border-slate-800">
              Encontrados <span id="customers-count">0</span> clientes.
            </div>
          </div>
        </div>

        <!-- ABA SOBRE -->
        <div id="tab-sobre" class="space-y-3 hidden text-sm text-slate-300">
          <h2 class="text-lg font-semibold text-slate-50">Sobre o painel</h2>
          <p>
            Este painel consome a API
            <code class="px-2 py-1 rounded bg-slate-900 border border-slate-800 text-xs" id="about-api-url"></code>
            conectada ao Firebase (Firestore).
          </p>
          <ul class="list-disc ml-5 space-y-1 text-slate-400 text-xs">
            <li>Cadastro e listagem de insumos em <code>/products</code>.</li>
            <li>Hist√≥rico de compras e estoque em <code>/products/:id/purchase</code> e <code>/products/:id/history</code>.</li>
            <li>Pedidos de mesa, app e Nicochat em <code>/orders</code>.</li>
            <li>Clientes (CRM simples) em <code>/customers</code> e <code>/customers/:phone</code> (para ligar depois).</li>
          </ul>
          <p class="text-xs text-slate-500">
            Pr√≥ximos passos: tela de hist√≥rico detalhado, custos por prato, relat√≥rios por per√≠odo e integra√ß√£o visual com Nicochat.
          </p>
        </div>

      </section>
    </main>
  </div>

  <!-- MODAL: Hist√≥rico de compras -->
  <div id="history-modal"
       class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="w-full max-w-2xl rounded-2xl bg-slate-950 border border-slate-800 shadow-xl">
      <!-- Cabe√ßalho -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
        <div>
          <h3 class="text-sm font-semibold text-slate-100">Hist√≥rico de compras</h3>
          <p class="text-xs text-slate-500">
            Produto:
            <span id="history-product-name" class="font-medium text-slate-200"></span>
          </p>
        </div>
        <button id="history-modal-close"
                class="text-xs text-slate-400 hover:text-slate-200">
          ‚úï Fechar
        </button>
      </div>

      <!-- Corpo -->
      <div class="px-4 py-3 max-h-80 overflow-auto">
        <table class="w-full text-xs">
          <thead class="bg-slate-900/60 sticky top-0 z-10">
            <tr>
              <th class="text-left px-3 py-2 font-semibold text-slate-400">Data</th>
              <th class="text-right px-3 py-2 font-semibold text-slate-400">Qtd</th>
              <th class="text-right px-3 py-2 font-semibold text-slate-400">Valor total (R$)</th>
              <th class="text-right px-3 py-2 font-semibold text-slate-400">Valor unit. (R$)</th>
            </tr>
          </thead>
          <tbody id="history-table-body" class="divide-y divide-slate-800">
            <!-- Linhas via JS -->
          </tbody>
        </table>

        <p id="history-empty-message"
           class="text-xs text-slate-500 text-center py-4 hidden">
          Nenhuma compra registrada para este produto.
        </p>
      </div>
    </div>
  </div>

  <!-- üìä MODAL DE RELAT√ìRIOS / BI DO PRODUTO -->
  <div
    id="report-modal"
    class="hidden fixed inset-0 z-50 bg-black/70 flex items-center justify-center px-2 sm:px-4"
  >
    <div class="bg-slate-900 border border-slate-700 rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
      <!-- Cabe√ßalho -->
      <div class="px-4 sm:px-6 py-3 border-b border-slate-700 flex items-center justify-between">
        <div>
          <h2 class="text-sm sm:text-base font-semibold text-slate-100">
            Relat√≥rios do produto
            <span id="rep-product-name" class="text-amber-300"></span>
            <span id="rep-product-unit" class="text-slate-400 text-xs"></span>
          </h2>
          <p class="text-[11px] text-slate-400">
            Hist√≥rico de compras, varia√ß√£o de pre√ßos, m√©dia das √∫ltimas compras e s√©rie temporal.
          </p>
        </div>
        <button
          id="report-close"
          class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-300 text-sm"
        >
          ‚úï
        </button>
      </div>

      <!-- Conte√∫do -->
      <div class="flex-1 overflow-auto p-4 sm:p-6 space-y-4">
        <!-- Linha de cards-resumo -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-slate-900/70 border border-slate-700 rounded-xl p-3">
            <p class="text-[11px] text-slate-400">√öltimo pre√ßo</p>
            <p id="rep-last-price" class="text-sm font-semibold text-emerald-400 mt-1">
              R$ 0,00
            </p>
            <p id="rep-last-date" class="text-[11px] text-slate-500 mt-1">
              ‚Äì
            </p>
            <p id="rep-last-supplier" class="text-[10px] text-slate-500 mt-1">
              Fornecedor: ‚Äì
            </p>
          </div>

          <div class="bg-slate-900/70 border border-slate-700 rounded-xl p-3">
            <p class="text-[11px] text-slate-400">Pre√ßo anterior</p>
            <p id="rep-prev-price" class="text-sm font-semibold text-slate-100 mt-1">
              ‚Äì
            </p>
            <p id="rep-prev-date" class="text-[11px] text-slate-500 mt-1">
              ‚Äì
            </p>
          </div>

          <div class="bg-slate-900/70 border border-slate-700 rounded-xl p-3">
            <p class="text-[11px] text-slate-400">M√©dia das √∫ltimas 4 compras</p>
            <p id="rep-avg4" class="text-sm font-semibold text-sky-300 mt-1">
              ‚Äì
            </p>
            <p id="rep-total-purchases" class="text-[11px] text-slate-500 mt-1">
              ‚Äì
            </p>
          </div>

          <div class="bg-slate-900/70 border border-slate-700 rounded-xl p-3">
            <p class="text-[11px] text-slate-400">Tend√™ncia do pre√ßo</p>
            <p id="rep-trend" class="text-sm font-semibold mt-1">
              ‚Äì
            </p>
            <p id="rep-chart-meta" class="text-[11px] text-slate-500 mt-1">
              ‚Äì
            </p>
          </div>
        </div>

        <!-- Gr√°fico -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-xl p-3 sm:p-4 h-64 sm:h-72 flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[11px] text-slate-400">
              S√©rie temporal do pre√ßo unit√°rio (todas as compras)
            </p>
          </div>
          <div class="flex-1">
            <canvas id="rep-price-chart"></canvas>
          </div>
        </div>

        <!-- Tabela de hist√≥rico detalhado -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-xl overflow-hidden">
          <div class="px-3 py-2 border-b border-slate-700 flex items-center justify-between">
            <p class="text-[11px] text-slate-400">
              Hist√≥rico de compras detalhado (da mais recente para a mais antiga)
            </p>
          </div>
          <div class="max-h-64 overflow-auto">
            <table class="min-w-full text-[11px]">
              <thead class="bg-slate-950/60 text-slate-400">
                <tr>
                  <th class="px-2 py-2 text-left font-medium">Data</th>
                  <th class="px-2 py-2 text-right font-medium">Quantidade</th>
                  <th class="px-2 py-2 text-right font-medium">Pre√ßo unit√°rio</th>
                  <th class="px-2 py-2 text-right font-medium">Valor total</th>
                  <th class="px-2 py-2 text-left font-medium">Fornecedor</th>
                  <th class="px-2 py-2 text-right font-medium">Estoque ap√≥s</th>
                </tr>
              </thead>
              <tbody id="rep-history-body" class="divide-y divide-slate-800">
                <!-- linhas preenchidas via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Rodap√© -->
      <div class="px-4 sm:px-6 py-2 border-t border-slate-800 text-[11px] text-slate-500 flex items-center justify-between">
        <span>
          Dica: use estes dados para ajustar o pre√ßo de venda de acordo com a tend√™ncia de custo.
        </span>
        <span class="hidden sm:inline">
          Saleh Digital ¬∑ BI de compras
        </span>
      </div>
    </div>
  </div>


  <!-- MODAL: Ficha t√©cnica do prato -->
  <div
    id="dish-modal"
    class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center px-2 sm:px-4 hidden"
  >
    <div
      class="bg-slate-950 border border-slate-800 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col"
    >
      <!-- Cabe√ßalho -->
      <div
        class="px-4 sm:px-6 py-3 border-b border-slate-800 flex items-center justify-between"
      >
        <div>
          <h2 class="text-sm sm:text-base font-semibold text-slate-100">
            Nova ficha t√©cnica de prato
          </h2>
          <p class="text-[11px] text-slate-400">
            Use os insumos cadastrados para calcular o custo da receita.
          </p>
        </div>
        <button
          id="btn-close-dish-modal"
          class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-300 text-sm"
        >
          ‚úï
        </button>
      </div>

      <!-- Conte√∫do -->
      <div class="flex-1 overflow-auto p-4 sm:p-6">
        <form id="dish-form" class="space-y-4 text-xs sm:text-sm">
          <!-- Dados gerais do prato -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="sm:col-span-2">
              <label class="block text-[11px] text-slate-400 mb-1">Nome do prato</label>
              <input
                type="text"
                id="dish-name"
                required
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
              />
            </div>
            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                Rendimento (por√ß√µes)
              </label>
              <input
                type="number"
                min="1"
                id="dish-yield"
                value="1"
                required
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                Pre√ßo de venda por por√ß√£o (R$)
              </label>
              <input
                type="number"
                step="0.01"
                id="dish-sale-price"
                value="0"
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
              />
            </div>
          </div>

          <!-- Ingredientes -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-400">
                Ingredientes da ficha t√©cnica
              </p>
              <button
                type="button"
                id="btn-add-ingredient-row"
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl text-[11px] font-medium bg-slate-800 text-slate-100 hover:bg-slate-700"
              >
                ‚ûï Adicionar ingrediente
              </button>
            </div>

            <div class="border border-slate-800 rounded-xl overflow-hidden">
              <div class="max-h-60 overflow-auto">
                <table class="min-w-full text-[11px]">
                  <thead class="bg-slate-900/80 text-slate-400">
                    <tr>
                      <th class="px-2 py-2 text-left font-medium">Insumo</th>
                      <th class="px-2 py-2 text-right font-medium">Qtd. na receita</th>
                      <th class="px-2 py-2 text-right font-medium">Unidade</th>
                      <th class="px-2 py-2 text-right font-medium">Custo estimado</th>
                      <th class="px-2 py-2 text-center font-medium">A√ß√£o</th>
                    </tr>
                  </thead>
                  <tbody id="ingredients-body" class="divide-y divide-slate-800">
                    <!-- linhas via JS -->
                  </tbody>
                </table>
              </div>
            </div>
            <p class="text-[11px] text-slate-500">
              A unidade e o valor por unidade v√™m do cadastro de insumos. Voc√™ s√≥ informa quanto vai na receita.
            </p>
          </div>
        </form>
      </div>

      <!-- Rodap√© -->
      <div
        class="px-4 sm:px-6 py-3 border-t border-slate-800 flex items-center justify-between text-[11px]"
      >
        <span class="text-slate-500">
          O custo √© calculado automaticamente com base nos pre√ßos atuais dos insumos.
        </span>
        <div class="flex items-center gap-2">
          <button
            type="button"
            id="btn-cancel-dish"
            class="px-3 py-1.5 rounded-xl border border-slate-700 text-slate-300 hover:bg-slate-900"
          >
            Cancelar
          </button>
          <button
            form="dish-form"
            type="submit"
            class="px-4 py-1.5 rounded-xl bg-emerald-500 text-slate-950 text-[11px] font-semibold hover:bg-emerald-400"
          >
            Salvar ficha
          </button>
        </div>
      </div>
    </div>
  </div>


  
  <!-- SCRIPT PRINCIPAL -->
  <script>
    // üîó URL da sua API no Render
    const API_BASE = "https://saleh-digital-api.onrender.com";

    // Refer√™ncias de elementos
    const apiStatusText = document.getElementById("api-status-text");
    const cardApiStatus = document.getElementById("card-api-status");
    const cardApiUrl = document.getElementById("card-api-url");
    const cardTotalProducts = document.getElementById("card-total-products");
    const cardPendingOrders = document.getElementById("card-pending-orders");
    const aboutApiUrl = document.getElementById("about-api-url");

    const tabEstoque = document.getElementById("tab-estoque");
    const tabPedidos = document.getElementById("tab-pedidos");
    const tabSobre = document.getElementById("tab-sobre");
    const tabCrm = document.getElementById("tab-crm");
    const tabFichas = document.getElementById("tab-fichas"); // NOVO

    const btnMenuEstoque = document.getElementById("menu-estoque");
    const btnMenuPedidos = document.getElementById("menu-pedidos");
    const btnMenuSobre = document.getElementById("menu-sobre");
    const btnMenuCrm = document.getElementById("menu-crm");
    const btnMenuFichas = document.getElementById("menu-fichas"); // NOVO

    // ---- Fichas t√©cnicas: elementos do modal ----
    const dishModal = document.getElementById("dish-modal");
    const btnOpenDishModal = document.getElementById("btn-open-dish-modal");
    const btnCloseDishModal = document.getElementById("btn-close-dish-modal");
    const btnCancelDish = document.getElementById("btn-cancel-dish");

    const dishForm = document.getElementById("dish-form");
    const dishNameInput = document.getElementById("dish-name");
    const dishYieldInput = document.getElementById("dish-yield");
    const dishSalePriceInput = document.getElementById("dish-sale-price");

    const btnAddIngredientRow = document.getElementById("btn-add-ingredient-row");
    const ingredientsBody = document.getElementById("ingredients-body");
    const dishCardsContainer = document.getElementById("dish-cards");


    
    
    const btnOpenProductForm = document.getElementById("btn-open-product-form");
    const btnCloseProductForm = document.getElementById("btn-close-product-form");
    const btnCancelProduct = document.getElementById("btn-cancel-product");
    const productFormContainer = document.getElementById("product-form-container");
    const productForm = document.getElementById("product-form");

    const productsTableBody = document.getElementById("products-table-body");
    const productsCount = document.getElementById("products-count");
    const searchProductsInput = document.getElementById("search-products");

    const ordersStatusFilter = document.getElementById("orders-status-filter");
    const ordersTableBody = document.getElementById("orders-table-body");
    const ordersCount = document.getElementById("orders-count");

    // ---- CRM ----
    const crmForm = document.getElementById("crm-form");
    const crmName = document.getElementById("crm-name");
    const crmPhone = document.getElementById("crm-phone");
    const crmChannel = document.getElementById("crm-channel");
    const crmNotes = document.getElementById("crm-notes");

    const searchCustomersInput = document.getElementById("search-customers");
    const customersTableBody = document.getElementById("customers-table-body");
    const customersCount = document.getElementById("customers-count");

    // --------- elementos do modal de hist√≥rico ---------
    const historyModal = document.getElementById("history-modal");
    const historyModalClose = document.getElementById("history-modal-close");
    const historyProductName = document.getElementById("history-product-name");
    const historyTableBody = document.getElementById("history-table-body");
    const historyEmptyMessage = document.getElementById("history-empty-message");

    historyModalClose.addEventListener("click", () => {
      historyModal.classList.add("hidden");
    });

    historyModal.addEventListener("click", (e) => {
      if (e.target === historyModal) {
        historyModal.classList.add("hidden");
      }
    });

  let allProducts = [];
  let stockChart = null;
  let allCustomers = [];
  let dishList = [];        // fichas t√©cnicas em mem√≥ria
  let editingDishId = null; // ‚¨ÖÔ∏è id da ficha que est√° sendo editada (ou null se for nova)



        // Carregar fichas t√©cnicas do Firestore
// Carregar fichas t√©cnicas do Firestore
async function loadDishes() {
  try {
    const res = await fetch(API_BASE + "/dishes");
    const data = await res.json();
    dishList = (Array.isArray(data) ? data : []).map((d) => ({
      ...d,
      yieldQty: d.yieldQty ?? d.yieldPortions ?? 1,
    }));
    renderDishCards();
  } catch (err) {
    console.error("Erro ao carregar fichas t√©cnicas:", err);
    alert("Erro ao carregar fichas t√©cnicas.");
  }
}


        // ==============================
    // üîÑ Navega√ß√£o entre abas
    // ==============================
    function showTab(tab) {
      // esconde todas
      tabEstoque.classList.add("hidden");
      tabPedidos.classList.add("hidden");
      tabSobre.classList.add("hidden");
      tabCrm.classList.add("hidden");
      tabFichas.classList.add("hidden");

      // reseta todos os bot√µes
      [btnMenuEstoque, btnMenuPedidos, btnMenuCrm, btnMenuSobre, btnMenuFichas].forEach((btn) => {
        btn.classList.remove("bg-slate-800", "text-amber-400");
        btn.classList.add("text-slate-300");
      });

      // exibe a aba selecionada
      if (tab === "estoque") {
        tabEstoque.classList.remove("hidden");
        btnMenuEstoque.classList.add("bg-slate-800", "text-amber-400");
        btnMenuEstoque.classList.remove("text-slate-300");
      } else if (tab === "pedidos") {
        tabPedidos.classList.remove("hidden");
        btnMenuPedidos.classList.add("bg-slate-800", "text-amber-400");
        btnMenuPedidos.classList.remove("text-slate-300");
      } else if (tab === "crm") {
        tabCrm.classList.remove("hidden");
        btnMenuCrm.classList.add("bg-slate-800", "text-amber-400");
        btnMenuCrm.classList.remove("text-slate-300");
      } else if (tab === "sobre") {
        tabSobre.classList.remove("hidden");
        btnMenuSobre.classList.add("bg-slate-800", "text-amber-400");
        btnMenuSobre.classList.remove("text-slate-300");
      } else if (tab === "fichas") {
        tabFichas.classList.remove("hidden");
        btnMenuFichas.classList.add("bg-slate-800", "text-amber-400");
        btnMenuFichas.classList.remove("text-slate-300");
      }
    }

    btnMenuEstoque.addEventListener("click", () => showTab("estoque"));
    btnMenuPedidos.addEventListener("click", () => {
      showTab("pedidos");
      loadOrders();
    });
    btnMenuSobre.addEventListener("click", () => showTab("sobre"));
    btnMenuCrm.addEventListener("click", () => showTab("crm"));

    btnMenuFichas.addEventListener("click", () => {
      showTab("fichas");
      loadDishes(); // carrega as fichas do banco sempre que abrir a aba
    });


    

    // -----------------------------
    // Abrir / fechar formul√°rio
    // -----------------------------
    function openProductForm() {
      productFormContainer.classList.remove("hidden");
    }
    function closeProductForm() {
      productFormContainer.classList.add("hidden");
    }

    btnOpenProductForm.addEventListener("click", openProductForm);
    btnCloseProductForm.addEventListener("click", closeProductForm);
    btnCancelProduct.addEventListener("click", closeProductForm);

    // -----------------------------
    // Status da API
    // -----------------------------
    async function checkApiStatus() {
      try {
        const res = await fetch(API_BASE + "/");
        if (!res.ok) throw new Error("Status n√£o OK");
        await res.text();
        apiStatusText.textContent = "Online";
        cardApiStatus.textContent = "API em funcionamento";
        cardApiStatus.classList.remove("text-slate-400");
        cardApiStatus.classList.add("text-emerald-400");
      } catch (err) {
        apiStatusText.textContent = "Offline ou indispon√≠vel";
        cardApiStatus.textContent = "Erro ao conectar na API";
        cardApiStatus.classList.remove("text-emerald-400");
        cardApiStatus.classList.add("text-rose-400");
      }
      cardApiUrl.textContent = API_BASE;
      aboutApiUrl.textContent = API_BASE;
    }

    // -----------------------------
    // Produtos
    // -----------------------------
    async function loadProducts() {
      try {
        const res = await fetch(API_BASE + "/products");
        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];
        renderProductsTable();
        cardTotalProducts.textContent = allProducts.length.toString();
        updateStockChart();
      } catch (err) {
        console.error("Erro ao carregar produtos:", err);
      }
    }

    function renderProductsTable() {
      const term = searchProductsInput.value.toLowerCase();
      const filtered = allProducts.filter(p => {
        const desc = (p.description || "").toLowerCase();
        const unit = (p.unit || "").toLowerCase();
        const loc = (p.location || "").toLowerCase();
        return desc.includes(term) || unit.includes(term) || loc.includes(term);
      });

      productsTableBody.innerHTML = "";

      if (filtered.length === 0) {
        productsTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-4 text-xs text-slate-500 text-center">
              Nenhum produto encontrado.
            </td>
          </tr>
        `;
        productsCount.textContent = "0";
        return;
      }

      filtered.forEach(p => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60";

        const currentQty = Number(p.currentQuantity || 0);
        const unitPrice = Number(p.unitPrice || 0);

        tr.innerHTML = `
          <td class="px-4 py-3 text-sm">${p.description || "-"}</td>
          <td class="px-4 py-3 text-sm">${p.unit || "-"}</td>
          <td class="px-4 py-3 text-sm text-right">R$ ${unitPrice.toFixed(2)}</td>
          <td class="px-4 py-3 text-sm text-right">${currentQty.toFixed(2)}</td>
          <td class="px-4 py-3 text-xs text-slate-400">${p.location || "-"}</td>
          <td class="px-4 py-3 text-right text-xs whitespace-nowrap">
            <span class="cursor-pointer hover:underline text-amber-400 font-medium" data-action="purchase" data-id="${p.id}">
              Registrar
            </span>
            <span class="text-slate-600 mx-1">‚Ä¢</span>
            <span class="cursor-pointer hover:underline text-slate-200" data-action="edit" data-id="${p.id}">
              Editar
            </span>
            <span class="text-slate-600 mx-1">‚Ä¢</span>
            <span class="cursor-pointer hover:underline text-slate-400" data-action="history" data-id="${p.id}">
              Hist√≥rico
            </span>
            <span class="text-slate-600 mx-1">‚Ä¢</span>
            <span class="cursor-pointer hover:underline text-sky-400" data-action="report" data-id="${p.id}">
              Relat√≥rios
            </span>
          </td>
        `;

        productsTableBody.appendChild(tr);
      });

      productsCount.textContent = filtered.length.toString();
    }

    searchProductsInput.addEventListener("input", () => {
      renderProductsTable();
    });

    // Registrar compra
    async function handlePurchase(productId) {
      const quantityStr = prompt("Quantidade comprada (mesma unidade do produto):");
      if (!quantityStr) return;
      const quantity = Number(quantityStr.replace(",", "."));
      if (isNaN(quantity) || quantity <= 0) {
        alert("Quantidade inv√°lida.");
        return;
      }

      const totalStr = prompt("Valor total pago (R$):");
      if (!totalStr) return;
      const totalPrice = Number(totalStr.replace(",", "."));
      if (isNaN(totalPrice) || totalPrice <= 0) {
        alert("Valor inv√°lido.");
        return;
      }

      const dateStr = prompt("Data da compra (AAAA-MM-DD). Deixe em branco para usar a data de hoje:");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const purchaseDate = dateStr && dateStr.trim() !== "" ? dateStr.trim() : `${yyyy}-${mm}-${dd}`;

      try {
        const res = await fetch(`${API_BASE}/products/${productId}/purchase`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity, totalPrice, purchaseDate })
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao registrar compra:", errText);
          alert("Erro ao registrar compra. Veja o console para detalhes.");
          return;
        }

        alert("Compra registrada com sucesso! Estoque atualizado.");
        await loadProducts();
      } catch (err) {
        console.error("Erro na requisi√ß√£o de compra:", err);
        alert("Erro de conex√£o ao registrar compra.");
      }
    }

    // clique nos links de a√ß√£o
    productsTableBody.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!id) return;

      if (action === "purchase") {
        handlePurchase(id);
      } else if (action === "edit") {
        handleEditProduct(id);
      } else if (action === "history") {
        handleShowHistory(id);
      } else if (action === "report") {
        handleShowReport(id);
      }
    });

    // Editar produto
    async function handleEditProduct(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) {
        alert("Produto n√£o encontrado na lista carregada.");
        return;
      }

      const novaDescricao = prompt(
        "Nova descri√ß√£o para o produto:",
        product.description || ""
      );

      if (!novaDescricao || novaDescricao.trim() === "") {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/products/${productId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description: novaDescricao.trim() })
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao editar produto:", errText);
          alert("Erro ao editar produto. Veja o console para detalhes.");
          return;
        }

        alert("Produto atualizado com sucesso!");
        await loadProducts();
      } catch (err) {
        console.error("Erro na requisi√ß√£o de edi√ß√£o:", err);
        alert("Erro de conex√£o ao editar produto.");
      }
    }

    // Hist√≥rico em modal
    async function handleShowHistory(productId) {
      try {
        const res = await fetch(`${API_BASE}/products/${productId}/history`);
        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao buscar hist√≥rico:", errText);
          alert("Erro ao buscar hist√≥rico de compras.");
          return;
        }

        const history = await res.json();
        const product = allProducts.find(p => p.id === productId);
        historyProductName.textContent = product ? (product.description || "-") : "-";

        historyTableBody.innerHTML = "";

        if (!Array.isArray(history) || history.length === 0) {
          historyEmptyMessage.classList.remove("hidden");
        } else {
          historyEmptyMessage.classList.add("hidden");

          history.forEach((h) => {
            const qtd = Number(h.quantity || 0);
            const total = Number(h.totalPrice || 0);
            const unit = Number(h.unitPrice || (qtd > 0 ? total / qtd : 0));
            const dataStr = h.purchaseDate || h.date || "";

            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-900/60";
            tr.innerHTML = `
              <td class="px-3 py-2">${dataStr}</td>
              <td class="px-3 py-2 text-right">${qtd.toFixed(2)}</td>
              <td class="px-3 py-2 text-right">R$ ${total.toFixed(2)}</td>
              <td class="px-3 py-2 text-right">R$ ${unit.toFixed(2)}</td>
            `;
            historyTableBody.appendChild(tr);
          });
        }

        historyModal.classList.remove("hidden");
      } catch (err) {
        console.error("Erro na requisi√ß√£o de hist√≥rico:", err);
        alert("Erro de conex√£o ao buscar hist√≥rico.");
      }
    }

    // ==============================
    // üìä RELAT√ìRIOS / BI DO PRODUTO
    // ==============================
    const reportModal = document.getElementById("report-modal");
    const reportClose = document.getElementById("report-close");

    const repProductName = document.getElementById("rep-product-name");
    const repProductUnit = document.getElementById("rep-product-unit");

    const repLastPrice = document.getElementById("rep-last-price");
    const repLastDate = document.getElementById("rep-last-date");
    const repPrevPrice = document.getElementById("rep-prev-price");
    const repPrevDate = document.getElementById("rep-prev-date");
    const repAvg4 = document.getElementById("rep-avg4");
    const repTotalPurchases = document.getElementById("rep-total-purchases");
    const repTrend = document.getElementById("rep-trend");
    const repLastSupplier = document.getElementById("rep-last-supplier");
    const repChartMeta = document.getElementById("rep-chart-meta");
    const repHistoryBody = document.getElementById("rep-history-body");

    let repPriceChart = null;

    function formatCurrencyBI(value) {
      if (value == null || isNaN(value)) return "‚Äì";
      return value.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2
      });
    }

    function formatDateLabelBI(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString("pt-BR");
    }

    function openReportModal() {
      reportModal.classList.remove("hidden");
    }

    function closeReportModal() {
      reportModal.classList.add("hidden");
      if (repPriceChart) {
        repPriceChart.destroy();
        repPriceChart = null;
      }
    }

    if (reportClose) {
      reportClose.addEventListener("click", closeReportModal);
    }
    if (reportModal) {
      reportModal.addEventListener("click", (e) => {
        if (e.target === reportModal) {
          closeReportModal();
        }
      });
    }

    async function handleShowReport(productId) {
      const product = allProducts.find(p => p.id === productId);

      repProductName.textContent = product ? (product.description || "-") : "-";
      repProductUnit.textContent = product ? `(${product.unit || "-"})` : "";

      repLastPrice.textContent = "Carregando...";
      repPrevPrice.textContent = "Carregando...";
      repAvg4.textContent = "Carregando...";
      repTrend.textContent = "Carregando...";
      repLastDate.textContent = "‚Äì";
      repPrevDate.textContent = "‚Äì";
      repLastSupplier.textContent = "Fornecedor: ‚Äì";
      repChartMeta.textContent = "";
      repHistoryBody.innerHTML = `
        <tr>
          <td colspan="6" class="px-2 py-3 text-center text-slate-500">
            Carregando hist√≥rico...
          </td>
        </tr>
      `;

      openReportModal();

      try {
        const res = await fetch(`${API_BASE}/products/${productId}/history`);
        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao buscar hist√≥rico para BI:", errText);
          repHistoryBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-2 py-3 text-center text-rose-400">
                Erro ao carregar hist√≥rico.
              </td>
            </tr>
          `;
          repLastPrice.textContent = "Erro";
          repPrevPrice.textContent = "Erro";
          repAvg4.textContent = "Erro";
          repTrend.textContent = "Erro";
          return;
        }

        let history = await res.json();

        // aceita purchaseDate OU date e v√°rios formatos de data
history = history
  .map((h) => {
    const dateStr = h.purchaseDate || h.date || "";
    const d = parseDateFlexible(dateStr);
    return { ...h, _dateObj: d };
  })
  .filter((h) => h._dateObj && !isNaN(h._dateObj))
  .sort((a, b) => a._dateObj - b._dateObj);


        if (history.length === 0) {
          repLastPrice.textContent = "‚Äì";
          repPrevPrice.textContent = "‚Äì";
          repAvg4.textContent = "‚Äì";
          repTrend.textContent = "Sem compras";
          repLastDate.textContent = "‚Äì";
          repPrevDate.textContent = "‚Äì";
          repLastSupplier.textContent = "Fornecedor: ‚Äì";
          repChartMeta.textContent = "Sem dados";
          repHistoryBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-2 py-3 text-center text-slate-500">
                Nenhuma compra registrada para este produto.
              </td>
            </tr>
          `;
          return;
        }

        const last = history[history.length - 1];
        const prev = history.length > 1 ? history[history.length - 2] : null;

        const lastPrice = last.unitPrice || 0;
        const prevPrice = prev ? (prev.unitPrice || 0) : null;

        repLastPrice.textContent = formatCurrencyBI(lastPrice);
        repLastDate.textContent = `√öltima compra em ${formatDateLabelBI(last.purchaseDate)}`;
        repLastSupplier.textContent = "Fornecedor: " + (last.supplier || "n√£o informado");

        if (prevPrice != null) {
          repPrevPrice.textContent = formatCurrencyBI(prevPrice);
          repPrevDate.textContent = `Anterior em ${formatDateLabelBI(prev.purchaseDate)}`;
        } else {
          repPrevPrice.textContent = "‚Äì";
          repPrevDate.textContent = "N√£o h√° compra anterior";
        }

        const last4 = history.slice(-4);
        const avg4 =
          last4.reduce((sum, h) => sum + (h.unitPrice || 0), 0) / last4.length;
        repAvg4.textContent = formatCurrencyBI(avg4);
        repTotalPurchases.textContent = `${history.length} compras registradas`;

        if (prevPrice != null && prevPrice !== 0) {
          const diff = lastPrice - prevPrice;
          const perc = (diff / prevPrice) * 100;
          const arrow = diff > 0 ? "‚ñ≤" : diff < 0 ? "‚ñº" : "‚ñ†";
          const color =
            diff > 0 ? "text-rose-400" : diff < 0 ? "text-emerald-400" : "text-slate-200";
          repTrend.innerHTML = `<span class="${color}">${arrow} ${formatCurrencyBI(diff)} (${perc.toFixed(1)}%)</span>`;
        } else {
          repTrend.textContent = "Sem compara√ß√£o (primeira compra)";
        }

        repHistoryBody.innerHTML = "";
        history
          .slice()
          .reverse()
          .forEach(h => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-900/60";
            tr.innerHTML = `
              <td class="px-2 py-1">${formatDateLabelBI(h.purchaseDate)}</td>
              <td class="px-2 py-1 text-right">${Number(h.quantity || 0).toLocaleString("pt-BR")}</td>
              <td class="px-2 py-1 text-right">${formatCurrencyBI(h.unitPrice || 0)}</td>
              <td class="px-2 py-1 text-right">${formatCurrencyBI(h.totalPrice || 0)}</td>
              <td class="px-2 py-1 text-left">${h.supplier || "-"}</td>
              <td class="px-2 py-1 text-right">${(h.stockAfter ?? "").toLocaleString("pt-BR")}</td>
            `;
            repHistoryBody.appendChild(tr);
          });

        const labels = history.map(h => h._dateObj.toLocaleDateString("pt-BR"));
        const prices = history.map(h => h.unitPrice || 0);

        repChartMeta.textContent = `${history.length} pontos de pre√ßo`;

        const ctx = document.getElementById("rep-price-chart").getContext("2d");
        if (repPriceChart) {
          repPriceChart.destroy();
        }
        repPriceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Pre√ßo unit√°rio (R$)",
                data: prices,
                borderWidth: 2,
                tension: 0.25
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: {
                  callback: (value) => formatCurrencyBI(value)
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("Erro ao carregar relat√≥rio de produto:", err);
        repHistoryBody.innerHTML = `
          <tr>
            <td colspan="6" class="px-2 py-3 text-center text-rose-400">
              Erro ao carregar dados do relat√≥rio.
            </td>
          </tr>
        `;
        repLastPrice.textContent = "Erro";
        repPrevPrice.textContent = "Erro";
        repAvg4.textContent = "Erro";
        repTrend.textContent = "Erro";
      }
    }


// Abrir modal de ficha t√©cnica (novo ou edi√ß√£o)
async function openDishModal(dishToEdit = null) {
  // garante que produtos estejam carregados
  if (!allProducts || allProducts.length === 0) {
    try {
      await loadProducts();
    } catch (err) {
      console.error("Erro ao carregar produtos para a ficha:", err);
      alert("N√£o consegui carregar os insumos. Verifique se a API /products est√° ok.");
      return;
    }
  }

  // define se √© edi√ß√£o ou novo
  editingDishId = dishToEdit ? dishToEdit.id : null;

  // limpa formul√°rio
  dishForm.reset();
  ingredientsBody.innerHTML = "";

  if (dishToEdit) {
    // MODO EDI√á√ÉO
    const y =
      Number(dishToEdit.yieldQty) ||
      Number(dishToEdit.yieldPortions) ||
      1;

    dishNameInput.value = dishToEdit.name || "";
    dishYieldInput.value = y;
    dishSalePriceInput.value = Number(dishToEdit.salePrice || 0);

    // recria as linhas de ingredientes
    if (Array.isArray(dishToEdit.ingredients)) {
      dishToEdit.ingredients.forEach((ing) => {
        addIngredientRow(ing); // passa ingrediente para preencher
      });
    } else {
      addIngredientRow();
    }
  } else {
    // NOVA FICHA
    dishYieldInput.value = 1;
    dishSalePriceInput.value = 0;
    addIngredientRow();
  }

  // abre modal
  dishModal.classList.remove("hidden");
}


    function closeDishModal() {
      dishModal.classList.add("hidden");
    }

    if (btnOpenDishModal) {
      btnOpenDishModal.addEventListener("click", openDishModal);
    }
    if (btnCloseDishModal) {
      btnCloseDishModal.addEventListener("click", closeDishModal);
    }
    if (btnCancelDish) {
      btnCancelDish.addEventListener("click", closeDishModal);
    }

   if (btnOpenDishModal) {
    btnOpenDishModal.addEventListener("click", () => openDishModal());
  }



 function addIngredientRow(initialIngredient = null) {
  const tr = document.createElement("tr");
  tr.className = "hover:bg-slate-900/60";

  tr.innerHTML = `
    <td class="px-2 py-2">
      <select
        class="ingredient-product w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1"
      >
        <option value="">Selecione o insumo</option>
      </select>
    </td>
    <td class="px-2 py-2 text-right">
      <input
        type="number"
        min="0"
        step="0.01"
        class="ingredient-qty w-20 text-right rounded-lg bg-slate-900 border border-slate-700 px-2 py-1"
      />
    </td>
    <td class="px-2 py-2 text-right">
      <span class="ingredient-unit text-slate-300">-</span>
    </td>
    <td class="px-2 py-2 text-right">
      <span class="ingredient-cost text-slate-300">R$ 0,00</span>
    </td>
    <td class="px-2 py-2 text-center">
      <button
        type="button"
        class="btn-remove-ingredient text-[11px] text-rose-400 hover:underline"
      >
        Remover
      </button>
    </td>
  `;

  const select = tr.querySelector(".ingredient-product");
  const qtyInput = tr.querySelector(".ingredient-qty");
  const unitSpan = tr.querySelector(".ingredient-unit");
  const costSpan = tr.querySelector(".ingredient-cost");
  const btnRemove = tr.querySelector(".btn-remove-ingredient");

  // popula o select com os produtos
  if (!allProducts || allProducts.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Nenhum insumo cadastrado";
    select.appendChild(opt);
  } else {
    allProducts.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.description || ""} (${p.unit || "-"})`;
      select.appendChild(opt);
    });
  }

  function recalcRow() {
    const id = select.value;
    const qty = Number(qtyInput.value || 0);
    const product = allProducts.find((p) => p.id === id);

    if (!product || !qty || isNaN(qty) || qty <= 0) {
      unitSpan.textContent = product && product.unit ? product.unit : "-";
      costSpan.textContent = "R$ 0,00";
      return;
    }

    const unitPrice = Number(product.unitPrice || 0);
    const cost = unitPrice * qty;

    unitSpan.textContent = product.unit || "-";
    costSpan.textContent = cost.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
  }

  select.addEventListener("change", recalcRow);
  qtyInput.addEventListener("input", recalcRow);

  btnRemove.addEventListener("click", () => {
    tr.remove();
  });

  // ‚öôÔ∏è Se veio um ingrediente para preencher (modo edi√ß√£o)
  if (initialIngredient) {
    select.value = initialIngredient.productId || "";
    qtyInput.value = initialIngredient.qty != null ? initialIngredient.qty : "";
    // for√ßa c√°lculo inicial
    recalcRow();
  }

  ingredientsBody.appendChild(tr);
}


    if (btnAddIngredientRow) {
      btnAddIngredientRow.addEventListener("click", () => {
        addIngredientRow();
      });
    }

    // salvar ficha
// salvar ficha (novo ou edi√ß√£o)
if (dishForm) {
  dishForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const name = dishNameInput.value.trim();
    const yieldQty = Number(dishYieldInput.value || 1);
    const salePrice = Number(dishSalePriceInput.value || 0);

    if (!name) {
      alert("Informe o nome do prato.");
      return;
    }
    if (!yieldQty || isNaN(yieldQty) || yieldQty <= 0) {
      alert("Informe um rendimento v√°lido (por√ß√µes).");
      return;
    }

    const rows = Array.from(ingredientsBody.querySelectorAll("tr"));
    if (rows.length === 0) {
      alert("Adicione pelo menos um ingrediente.");
      return;
    }

    const ingredients = [];
    let totalCost = 0;

    rows.forEach((tr) => {
      const select = tr.querySelector(".ingredient-product");
      const qtyInput = tr.querySelector(".ingredient-qty");

      const productId = select.value;
      const qty = Number(qtyInput.value || 0);
      if (!productId || !qty || isNaN(qty) || qty <= 0) return;

      const product = allProducts.find((p) => p.id === productId);
      if (!product) return;

      const unitPrice = Number(product.unitPrice || 0);
      const cost = unitPrice * qty;

      ingredients.push({
        productId,
        productName: product.description || "",
        unit: product.unit || "",
        qty,
        unitPrice,
        cost,
      });

      totalCost += cost;
    });

    if (ingredients.length === 0) {
      alert("Preencha corretamente pelo menos um ingrediente.");
      return;
    }

    const costPerPortion = totalCost / yieldQty;
    const marginValue = salePrice ? salePrice - costPerPortion : 0;
    const marginPercent =
      salePrice && salePrice > 0 ? (marginValue / salePrice) * 100 : 0;

    const dishPayload = {
      name,
      yieldPortions: yieldQty, // campo usado na API
      salePrice,
      costTotal: totalCost,
      costPerPortion,
      marginValue,
      marginPercent,
      ingredients,
    };

    const isEditing = !!editingDishId;
    const url = isEditing
      ? `${API_BASE}/dishes/${editingDishId}`
      : `${API_BASE}/dishes`;
    const method = isEditing ? "PATCH" : "POST";

    fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dishPayload),
    })
      .then((res) => {
        if (!res.ok) {
          return res.text().then((t) => {
            throw new Error(t || "Erro ao salvar ficha");
          });
        }
        return res.json();
      })
      .then((data) => {
        console.log("Ficha salva:", data);
        alert(isEditing ? "Ficha t√©cnica atualizada!" : "Ficha t√©cnica salva com sucesso!");
        closeDishModal();
        editingDishId = null;
        loadDishes(); // recarrega lista
      })
      .catch((err) => {
        console.error("Erro ao salvar ficha t√©cnica:", err);
        alert("Erro ao salvar ficha t√©cnica. Veja o console para detalhes.");
      });
  });
}


function renderDishCards() {
  dishCardsContainer.innerHTML = "";

  if (!dishList.length) {
    dishCardsContainer.innerHTML = `
      <div
        class="col-span-1 md:col-span-2 xl:col-span-3 text-xs text-slate-500 border border-dashed border-slate-800 rounded-2xl px-4 py-6 text-center"
      >
        Nenhuma ficha cadastrada ainda.
        Clique em <span class="font-semibold text-amber-400">‚ÄúNova ficha t√©cnica‚Äù</span> para criar a primeira.
      </div>
    `;
    return;
  }

  dishList.forEach((dish) => {
    const ingredientesArr = Array.isArray(dish.ingredients) ? dish.ingredients : [];

    const indicadores = calcularIndicadoresFicha(
      ingredientesArr.map((ing) => ({ custo: ing.cost })),
      dish.yieldQty,
      dish.salePrice
    );

    const custoTotal = indicadores.custoTotalReceita.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
    const custoPorPorcao = indicadores.custoPorPorcao.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
    const venda =
      indicadores.precoVenda > 0
        ? indicadores.precoVenda.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          })
        : "‚Äì";

    const lucroUnitario = indicadores.lucroUnitario.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
    const cmvStr = `${indicadores.cmvPercent.toFixed(1)}%`;
    const markupStr =
      indicadores.markupReal > 0
        ? `${indicadores.markupReal.toFixed(2)}x`
        : "‚Äì";

    const precoS30 = indicadores.precoSugerido30.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
    const precoS40 = indicadores.precoSugerido40.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });
    const precoS50 = indicadores.precoSugerido50.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
    });

    const card = document.createElement("div");
    card.className =
      "rounded-2xl bg-slate-950 border border-slate-800 p-4 flex flex-col gap-3 text-xs";

    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div>
          <h3 class="text-sm font-semibold text-slate-50">
            ${dish.name}
          </h3>
          <p class="text-[11px] text-slate-400">
            Rendimento: <span class="font-medium">${dish.yieldQty} por√ß√µes</span>
          </p>
        </div>
        <div class="flex gap-2 text-[11px]">
          <button
            class="text-sky-400 hover:underline"
            data-dish-action="edit"
            data-dish-id="${dish.id}"
          >
            Editar
          </button>
          <button
            class="text-rose-400 hover:underline"
            data-dish-action="delete"
            data-dish-id="${dish.id}"
          >
            Excluir
          </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="bg-slate-900/60 rounded-xl p-2">
          <p class="text-[10px] text-slate-400">Custo total da receita</p>
          <p class="text-sm font-semibold text-amber-300">${custoTotal}</p>
          <p class="text-[10px] text-slate-500">
            Custo por por√ß√£o: <span class="font-medium">${custoPorPorcao}</span>
          </p>
          <p class="text-[10px] text-slate-500 mt-1">
            CMV sobre venda: <span class="font-medium">${cmvStr}</span>
          </p>
          <p class="text-[10px] text-slate-500">
            Markup real: <span class="font-medium">${markupStr}</span>
          </p>
        </div>

        <div class="bg-slate-900/60 rounded-xl p-2">
          <p class="text-[10px] text-slate-400">Pre√ßo de venda</p>
          <p class="text-sm font-semibold text-emerald-300">${venda}</p>
          <p class="text-[10px] text-slate-500">
            Lucro unit√°rio: <span class="font-medium">${lucroUnitario}</span>
          </p>
          <div class="mt-2 border-t border-slate-700 pt-1">
            <p class="text-[10px] text-slate-400 mb-1">
              Sugest√£o de pre√ßo por CMV:
            </p>
            <p class="text-[10px] text-slate-500">
              30% CMV: <span class="font-medium">${precoS30}</span>
            </p>
            <p class="text-[10px] text-slate-500">
              40% CMV: <span class="font-medium">${precoS40}</span>
            </p>
            <p class="text-[10px] text-slate-500">
              50% CMV: <span class="font-medium">${precoS50}</span>
            </p>
          </div>
        </div>
      </div>

      <div class="bg-slate-900/60 rounded-xl p-2">
        <p class="text-[10px] text-slate-400 mb-1">
          Ingredientes da ficha
        </p>
        <div class="max-h-32 overflow-auto">
          <table class="w-full text-[10px]">
            <thead class="text-slate-400">
              <tr>
                <th class="text-left px-1 py-1">Insumo</th>
                <th class="text-right px-1 py-1">Qtd.</th>
                <th class="text-right px-1 py-1">Unid.</th>
                <th class="text-right px-1 py-1">Custo</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
              ${ingredientesArr
                .map((ing) => {
                  const c = ing.cost.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });
                  return `
                    <tr>
                      <td class="px-1 py-1">${ing.productName}</td>
                      <td class="px-1 py-1 text-right">${ing.qty.toFixed(2)}</td>
                      <td class="px-1 py-1 text-right">${ing.unit}</td>
                      <td class="px-1 py-1 text-right">${c}</td>
                    </tr>
                  `;
                })
                .join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;

    dishCardsContainer.appendChild(card);
  });
}

// Clique em Editar / Excluir ficha t√©cnica
dishCardsContainer.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-dish-action]");
  if (!btn) return;

  const action = btn.getAttribute("data-dish-action");
  const id = btn.getAttribute("data-dish-id");
  if (!id) return;

  const dish = dishList.find((d) => d.id === id);

  if (action === "edit") {
    if (!dish) {
      alert("Ficha n√£o encontrada na lista carregada.");
      return;
    }
    openDishModal(dish); // abre modal j√° preenchido
  }

  if (action === "delete") {
    if (!confirm("Tem certeza que deseja excluir esta ficha t√©cnica?")) return;

    fetch(`${API_BASE}/dishes/${id}`, {
      method: "DELETE",
    })
      .then((res) => {
        if (!res.ok) {
          return res.text().then((t) => {
            throw new Error(t || "Erro ao excluir ficha");
          });
        }
      })
      .then(() => {
        alert("Ficha t√©cnica exclu√≠da com sucesso!");
        loadDishes();
      })
      .catch((err) => {
        console.error("Erro ao excluir ficha t√©cnica:", err);
        alert("Erro ao excluir ficha t√©cnica. Veja o console para detalhes.");
      });
  }
});



    
    // -----------------------------
    // Pedidos
    // -----------------------------
    async function loadOrders() {
      const status = ordersStatusFilter.value;
      try {
        const res = await fetch(`${API_BASE}/orders?status=${encodeURIComponent(status)}`);
        const data = await res.json();
        const orders = Array.isArray(data) ? data : [];
        renderOrdersTable(orders);
        if (status === "pendente") {
          cardPendingOrders.textContent = orders.length.toString();
        }
      } catch (err) {
        console.error("Erro ao carregar pedidos:", err);
      }
    }

function renderOrdersTable(orders) {
  ordersTableBody.innerHTML = "";
  if (orders.length === 0) {
    ordersTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-4 py-4 text-xs text-slate-500 text-center">
          Nenhum pedido encontrado para este status.
        </td>
      </tr>
    `;
    ordersCount.textContent = "0";
    return;
  }

  orders.forEach(o => {
    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-900/60 text-xs";

    const itemsText = Array.isArray(o.items)
      ? o.items.map(i => `${i.qty}x ${i.name}`).join(", ")
      : "-";

    tr.innerHTML = `
      <td class="px-4 py-2 align-top">
        <div class="font-medium text-slate-100">${o.tableNumber || "-"}</div>
        <div class="text-[11px] text-slate-500">${o.channel || "-"}</div>
      </td>
      <td class="px-4 py-2 align-top">${o.customerName || "-"}</td>
      <td class="px-4 py-2 align-top">${itemsText}</td>
      <td class="px-4 py-2 align-top">
        <span class="px-2 py-1 rounded-full text-[10px] bg-slate-900 border border-slate-700 text-slate-200">
          ${o.status}
        </span>
      </td>
      <td class="px-4 py-2 align-top text-right"></td>
    `;
    ordersTableBody.appendChild(tr);
  });

  ordersCount.textContent = orders.length.toString();
}
    
    // -----------------------------
    // Gr√°fico de estoque
    // -----------------------------
    function updateStockChart() {
      const ctx = document.getElementById("stockChart");
      if (!ctx) return;

      const sorted = [...allProducts].sort(
        (a, b) => Number(b.currentQuantity || 0) - Number(a.currentQuantity || 0)
      );
      const top = sorted.slice(0, 6);
      const labels = top.map(p => p.description || "");
      const values = top.map(p => Number(p.currentQuantity || 0));

      if (stockChart) {
        stockChart.destroy();
      }

      stockChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Quantidade atual",
            data: values
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: "#e5e7eb", font: { size: 11 } }
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" }
            },
            y: {
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" }
            }
          }
        }
      });
    }

    // -----------------------------
    // Formul√°rio de novo produto
    // -----------------------------
    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const description = document.getElementById("pf-description").value.trim();
      const unit = document.getElementById("pf-unit").value.trim();
      const unitSize = document.getElementById("pf-unitSize").value.trim();
      const unitPrice = Number(
        document.getElementById("pf-unitPrice").value.replace(",", ".")
      );
      const yieldPercent = Number(
        document.getElementById("pf-yieldPercent").value || 100
      );
      const notes = document.getElementById("pf-notes").value.trim();
      const location = document.getElementById("pf-location").value.trim();
      const currentQuantity = Number(
        document
          .getElementById("pf-currentQuantity")
          .value.replace(",", ".") || 0
      );

      if (!description || !unit || isNaN(unitPrice)) {
        alert("Preencha ao menos descri√ß√£o, unidade e valor da unidade.");
        return;
      }

      const body = {
        description,
        unit,
        unitSize,
        unitPrice,
        yieldPercent,
        notes,
        location,
        previousQuantity: 0,
        purchaseQuantity: 0,
        currentQuantity
      };

      try {
        const res = await fetch(API_BASE + "/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao criar produto:", errText);
          alert("Erro ao criar produto. Veja o console para detalhes.");
          return;
        }

        alert("Produto cadastrado com sucesso!");
        productForm.reset();
        document.getElementById("pf-yieldPercent").value = 100;
        document.getElementById("pf-currentQuantity").value = 0;
        closeProductForm();
        await loadProducts();
      } catch (err) {
        console.error("Erro na requisi√ß√£o de produto:", err);
        alert("Erro de conex√£o ao salvar produto.");
      }
    });

    // -----------------------------
    // CRM: salvar cliente
    // -----------------------------
    crmForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = crmName.value.trim();
      const phone = crmPhone.value.trim();
      const channel = crmChannel.value;
      const notes = crmNotes.value.trim();

      if (!phone) {
        alert("Informe o telefone do cliente.");
        return;
      }

      try {
        const res = await fetch(API_BASE + "/customers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, phone, channel, notes })
        });

        if (!res.ok) {
          const errText = await res.text();
          console.error("Erro ao salvar cliente:", errText);
          alert("Erro ao salvar cliente. Veja o console para detalhes.");
          return;
        }

        await loadCustomers();
        crmForm.reset();
        alert("Cliente salvo com sucesso!");
      } catch (err) {
        console.error("Erro na requisi√ß√£o de cliente:", err);
        alert("Erro de conex√£o ao salvar cliente.");
      }
    });

    async function loadCustomers() {
      try {
        const res = await fetch(API_BASE + "/customers");
        const data = await res.json();
        allCustomers = Array.isArray(data) ? data : [];
        renderCustomersTable();
      } catch (err) {
        console.error("Erro ao carregar clientes:", err);
      }
    }

    function renderCustomersTable() {
      const term = (searchCustomersInput.value || "").toLowerCase();
      const filtered = allCustomers.filter(c => {
        const n = (c.name || "").toLowerCase();
        const p = (c.phone || "").toLowerCase();
        const ch = (c.channel || "").toLowerCase();
        return n.includes(term) || p.includes(term) || ch.includes(term);
      });

      customersTableBody.innerHTML = "";
      if (filtered.length === 0) {
        customersTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-4 text-xs text-slate-500 text-center">
              Nenhum cliente encontrado.
            </td>
          </tr>
        `;
        customersCount.textContent = "0";
        return;
      }

      filtered.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60 text-xs";
        tr.innerHTML = `
          <td class="px-4 py-2">${c.name || "-"}</td>
          <td class="px-4 py-2">${c.phone || "-"}</td>
          <td class="px-4 py-2">${c.channel || "-"}</td>
          <td class="px-4 py-2">${c.notes || "-"}</td>
        `;
        customersTableBody.appendChild(tr);
      });

      customersCount.textContent = filtered.length.toString();
    }

    searchCustomersInput.addEventListener("input", renderCustomersTable);

    // -----------------------------
    // Inicializa√ß√£o
    // -----------------------------
    async function initDashboard() {
      await checkApiStatus();
      await loadProducts();
      await loadOrders();
      await loadCustomers();
      await loadDishes();  // üÜï carrega fichas tamb√©m
      showTab("estoque");
    }

    document.addEventListener("DOMContentLoaded", initDashboard);


    // ===============================
// üìå C√ÅLCULO DE CMV DA FICHA T√âCNICA
// ===============================
function arred2(valor) {
  const n = Number(valor || 0);
  return Number(n.toFixed(2));
}



 // =======================
// üóìÔ∏è Parse flex√≠vel de datas
// =======================
function parseDateFlexible(dateStr) {
  if (!dateStr) return null;

  // quebra por / ou -
  const parts = dateStr.split(/[\/\-]/);

  if (parts.length !== 3) {
    const dRaw = new Date(dateStr);
    return isNaN(dRaw) ? null : dRaw;
  }

  // Se come√ßar com 4 d√≠gitos, assumo AAAA-MM-DD
  if (parts[0].length === 4) {
    const dIso = new Date(dateStr);
    return isNaN(dIso) ? null : dIso;
  }

  // Sen√£o assumo DD/MM/AAAA ou DD-MM-AAAA
  const [dd, mm, yyyy] = parts.map(n => parseInt(n, 10));
  if (!dd || !mm || !yyyy) return null;

  const d = new Date(yyyy, mm - 1, dd);
  return isNaN(d) ? null : d;
}
   

    
/**
 * ingredientes: array de objetos no formato:
 *   { nome: "Arroz", custo: 0.55 }
 *   - O campo "custo" √© o custo daquele ingrediente NA RECEITA (n√£o no kg inteiro).
 *
 * rendimento: n√∫mero de por√ß√µes da receita (ex.: 1, 4, 10...)
 * precoVenda: pre√ßo de venda de UMA por√ß√£o (ex.: 10.50)
 */
function calcularIndicadoresFicha(ingredientes, rendimento, precoVenda) {
  const rend = Number(rendimento || 1);
  const pv = Number(precoVenda || 0);

  // 1) Soma dos custos dos insumos
  const custoTotalReceita = ingredientes.reduce((soma, ing) => {
    const c = Number(ing.custo || 0);
    return soma + c;
  }, 0);

  // 2) Custo por por√ß√£o
  const custoPorPorcao = rend > 0 ? custoTotalReceita / rend : 0;

  // 3) Lucro unit√°rio (sem considerar outras despesas fixas)
  const lucroUnitario = pv - custoPorPorcao;

  // 4) % de CMV sobre o pre√ßo de venda
  const cmvPercent = pv > 0 ? (custoPorPorcao / pv) * 100 : 0;

  // 5) Markup real aplicado
  const markupReal = custoPorPorcao > 0 ? pv / custoPorPorcao : 0;

  // 6) Pre√ßos sugeridos para margens alvo (30%, 40%, 50%)
  const precoSug30 = custoPorPorcao / (1 - 0.30); // 30% CMV
  const precoSug40 = custoPorPorcao / (1 - 0.40); // 40% CMV
  const precoSug50 = custoPorPorcao / (1 - 0.50); // 50% CMV

  return {
    custoTotalReceita: arred2(custoTotalReceita),
    custoPorPorcao: arred2(custoPorPorcao),
    precoVenda: arred2(pv),
    lucroUnitario: arred2(lucroUnitario),
    cmvPercent: arred2(cmvPercent),
    markupReal: arred2(markupReal),

    precoSugerido30: arred2(precoSug30),
    precoSugerido40: arred2(precoSug40),
    precoSugerido50: arred2(precoSug50)
  };
}

    
  </script>
</body>
</html>
